<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chat-backend</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

    <script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" integrity="sha384-rOA1PnstxnOBLzCLMcre8ybwbTmemjzdNlILg8O7z1lUkLXozs4DHonlDtnE7fpc" crossorigin="anonymous">     
    </script>
    <link rel="stylesheet" href="/message.css">
    <link rel="icon" href="https://i.pinimg.com/originals/da/c4/bf/dac4bfad9993da7eddada931ebedc3e1.jpg">
</head>
<body>
  <div class="container-fluid">
    <div class="left">
        <div class="top">
            <div class="tub">
                <div class="username">Chat with:- <%-chatWith%> </div> 
                <input type="hidden" id="reciever_Id" value="<%=recieverId%>" >
                   </div>
            <div class="card"> 
                <!-- Button trigger modal -->
<button type="button" class="btn btn-primary latest" data-toggle="modal" data-target="#exampleModal">
   new
  </button>
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
            <div class="input-group mb-3">
                <input id="search" type="search" name="search" class="form-control" placeholder="Recipient's username" aria-label="Recipient's username" aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <button type="button" class="btn btn-primary search">search</button>
                </div>
              </div>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="body2">
        </div>

        <div class="modal-footer">
           
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
        </div>
        </div>
        <div class="conversations">
            <%-friendRequest%>
                <% for(var i=0; i<data.length; i++) { %>
            <div class="person">
                <div class="box">
                    <div class="image"> <img class="avatar" alt="Avatar" src=" " name = "<%-data[i].fullName%>" width="50px" height="50px" alt=""> </div>
                    <% if(data[i].isOnline === true){ %>
                        <div class="online" id ="<%=data[i].id%>online"></div>
                     <% } else{ %>
                        <div class="" id ="<%=data[i].id%>online"></div>
                      <% } %>
                </div>
                <div class="information">
                    <div class="username" style="display:flex; justify-content:space-between" >
                        <div>
                            <a class="userName1"  href='/api/conversation/message/<%- data[i].id%>'><%= data[i].fullName %></a>
                             
                            <div id="<%-data[i].id%>count" style=
                            "height: 25px;
                            width: 25px;
                            display: inline-block;
                            border: 1px solid black;
                            margin: auto;
                            border-radius: 50%;
                            background-color: #bcff82;
                            padding-left: 5%;
                            margin-left: 0%;" ></div>
                            <p id="<%-data[i].id%>"><%-data[i].lastMessage%></p>
                            <input class="allUserId" type="hidden" value="<%-data[i].id%>" >
                        </div>
                         <div>
                         </div>
                    </div>
                </div>
              
            </div>
            <% } %>
            
        </div>
    </div>
    
    <div class="right">
        <div class="top"  >
            <div class="box">
         </div>
            <div class="information">
                <div class="username"> <a href="#"><%-userName%></a></div>
                <div class="name"><p style="color: rgb(4, 121, 86);">Active now</p></div>
            </div>
            <div class="options">
                       <p>
                        <button class="btn btn-light" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                            &bull;&bull;&bull;
                        </button>
                      </p>

                       <!-- <h1 style="width:70% ;" ><%-userName%></h1> -->
                      <div class="collapse" id="collapseExample">
                        <div class="card card-body" style="margin-top:40%; display: flex; padding-bottom: 57%; margin-top: 57%; flex-direction: column; width:112px; height:125px;">
                            <div class="seeFriendRequestParent" >
 <a class="seeFriendRequest" href="/api/friendrequest"><i class="bi bi-bell-fill"></i></a><span style="color: red; font-weight: 700;" ><%-seeRequest.length%></span>
      <a id="logOut" href="/api/auth/user/logOut"  style="color: black;text-align: center;text-decoration: none;"> logOut</a>
      <a id="block" href="/api/user/block/<%=recieverId%>"  style="color: black;text-align: center;text-decoration: none;">Block</a>
      <a id="unFriend" href="/api/user/unFriend/<%=recieverId%>"> Unfriend
        <!-- <img class="shahiImage" src="/icons8-user-48.png"> -->
       </a>
                            </div>
                        </div>
                      </div>
              </div>
        </div>
        <div class="middle">
            <div class="tumbler" id="appendDiv">
                <div class="messages" id="two">
                    <div class="clip block">
                 <div class="blockText" >
                        <%=message%>
                        </div>
                    </div>
                        <% for(var i=0; i<showmessages.length; i++) {%>
                        <% if(showmessages[i].from === userId){%>
                            <% if(showmessages[i].isEdited === true ){%>
                        <div class="clip sent">
                            <div class="text"><%= showmessages[i].message%>
                               
                                <form action="/api/conversation/message/edit/<%=showmessages[i].id%>?recieverId=<%=recieverId%>" method="post" >
                                    <br>
                                  <a href="/api/conversation/message/delete/<%=showmessages[i].id%>?recieverId=<%=recieverId%>" id="delete" class="hide" >delete for everyOne</a>
                                    <input class="hide" id="messageHide" autocomplete="off"  placeholder="message" name="message" type="text">
                                <button id="editSubmit" class="hide" type="submit"> submit</button>
                                  </form>
                                <small class="timestampmsg">
                                    <%=showmessages[i].timeZone%>
                                </small>
                                <br>
                                <small id="edited-send">
                                    edited
                                </small>  
                                <% if (showmessages[i].state === "read") { %>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="15" 
                                    id="msg-dblcheck-ack" x="2063" y="2076"><path class="read" d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.88a.32.32 0 0 1-.484.032l-.358-.325a.32.32 0 0 0-.484.032l-.378.48a.418.418 0 0 0 .036.54l1.32 1.267a.32.32 0 0 0 .484-.034l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.88a.32.32 0 0 1-.484.032L1.892 7.77a.366.366 0 0 0-.516.005l-.423.433a.364.364 0 0 0 .006.514l3.255 3.185a.32.32 0 0 0 .484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z" fill="#4fc3f7"/></svg>
                                    <%} else { %>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="15"  id="msg-dblcheck-ack" x="2063" y="2076"><path class="unRead" d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.88a.32.32 0 0 1-.484.032l-.358-.325a.32.32 0 0 0-.484.032l-.378.48a.418.418 0 0 0 .036.54l1.32 1.267a.32.32 0 0 0 .484-.034l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.88a.32.32 0 0 1-.484.032L1.892 7.77a.366.366 0 0 0-.516.005l-.423.433a.364.364 0 0 0 .006.514l3.255 3.185a.32.32 0 0 0 .484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z" fill="#434c54"/></svg>
                                        <% } %> 
                                        
                                        <%} else { %>
                                            <div class="clip sent">
                                                <div class="text"><%= showmessages[i].message%>
                                                   
                                                    <form action="/api/conversation/message/edit/<%=showmessages[i].id%>?recieverId=<%=recieverId%>" method="post" >
                                                    <input class="hide" name="message" type="text">
                                                    <br>
                                                    <a href="/api/conversation/message/delete/<%=showmessages[i].id%>?recieverId=<%=recieverId%>" id="delete" class="hide">delete for everyone</a>
                                                    <button class="hide" type="submit"> submit</button>
                                                      </form>
                                                    <small class="timestampmsg">
                                                        <%=showmessages[i].timeZone%>
                                                    </small>
                                                    <% if (showmessages[i].state === "read") { %>
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="15" 
                                                        id="msg-dblcheck-ack" x="2063" y="2076"><path class="read" d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.88a.32.32 0 0 1-.484.032l-.358-.325a.32.32 0 0 0-.484.032l-.378.48a.418.418 0 0 0 .036.54l1.32 1.267a.32.32 0 0 0 .484-.034l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.88a.32.32 0 0 1-.484.032L1.892 7.77a.366.366 0 0 0-.516.005l-.423.433a.364.364 0 0 0 .006.514l3.255 3.185a.32.32 0 0 0 .484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z" fill="#4fc3f7"/></svg>
                                                        <%} else { %>
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="15"  id="msg-dblcheck-ack" x="2063" y="2076"><path class="unRead" d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.88a.32.32 0 0 1-.484.032l-.358-.325a.32.32 0 0 0-.484.032l-.378.48a.418.418 0 0 0 .036.54l1.32 1.267a.32.32 0 0 0 .484-.034l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.88a.32.32 0 0 1-.484.032L1.892 7.77a.366.366 0 0 0-.516.005l-.423.433a.364.364 0 0 0 .006.514l3.255 3.185a.32.32 0 0 0 .484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z" fill="#434c54"/></svg>
                                                            <% } %> 
                                                            <% } %> 
                        </div>
                        </div>
                        <% } %> 

                       <% if(showmessages[i].to === userId ){%>
                        <% if(showmessages[i].isEdited === true ){%>
                        <div class="clip received">
                            <div class="text" id="<%= showmessages[i].id%>"><%= showmessages[i].message%>
                                <small class="timestampmsg">
                                    <%=showmessages[i].timeZone%>
                                </small>
                                <br>
                                <small id="edited-recieved" >
                                    edited
                                </small>   
                                <%} else { %>
                                    <div class="clip received">
                                        <div class="text" id="<%= showmessages[i].id%>"><%= showmessages[i].message%>
                                            <small class="timestampmsg">
                                                <%=showmessages[i].timeZone%>
                                            </small>
                                    <% } %>   

                        </div>
                        </div>
                        <% }%>



                        <% } %>                        
                    </div>
            </div>
        </div>
        <div class="bottom">
            <div class="cup">
                <button class="mike" onclick = "getLocalStream()">
                    <i id="mikeIcon" class="bi bi-mic-fill"></i>
                </button>
            <form class="cup" action="/api/conversation/message/<%=recieverId%>" method="post">
                    <input type="text" autocomplete="off" class="mytextArea" id="message" name="message" cols="30"  rows="1" placeholder="Message..." autocomplete="on" required>
                    <!-- <i class="bi bi-emoji-smile-upside-down" id="myTextArea"></i> -->
                    <input type="hidden" id="recieverId" value="<%=recieverId%>">
                     <input type="hidden", id="senderId", value="<%=userId%>">
                    <button type="submit" class="send">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script> -->
<script src="/socket.io/socket.io.js"></script>
<script>  
// const {users} = require('../')

// const getLocalStream = async ()=>{
//     try{
//   const stream = await  navigator.mediaDevices.getUserMedia({video: false, audio: true})
//         console.log("<MMMM",stream);
//         window.localStream = stream;
//         window.localStream.srcObject = stream;
//         window.autoplay = true;
// // const SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
//         console.log("<<<<",window.SpeechRecognitionResult);
//         console.log("<<222",window.SpeechRecognitionAlternative);
// // const data = await start_microphone(stream);
// // console.log("data",data);
//     }
// catch(e){
// console.log("<<<<<<<<<<",e);
// }
// }


if ( window.history.replaceState ) {
  window.history.replaceState( null, null, window.location.href );
}


// document.querySelector('emoji-picker')
//   .addEventListener('emoji-click', event => console.log(event.detail));



// tinymce.init({
//     selector: ".mytextArea",
//     plugins: "emoticons",
//     toolbar: "emoticons",
//     toolbar_location: "top",
//     menubar: false
// });

const cookie = document.cookie.split("=")[1]
const socket = io()
// const socket = io.connect("'https://ecaa-122-168-233-60.in.ngrok.io'",{
//     query:`token=${cookie}`,
//     extraHeaders:{Authorization:`Bearer${cookie}`}
// })

//     const socket = io.connect('https://ecaa-122-168-233-60.in.ngrok.io', {
//   query: `token=${your_jwt}`,
//   extraHeaders : { Authorization: `Bearer ${your_jwt}`}
//     });

    const mailDiv = document.getElementById('message')

// socket.on("connection", ()=>{
//     console.log("connected");
// })

socket.on('login',(data)=>{
socket.emit("login",data)
// console.log(data);
// users.className = "online"
// socket.emit('disconnect',data)
})

socket.on('delete',(data)=>{
const {messageId} = data
const recieverMessage = document.getElementById(messageId)
recieverMessage.style.backgroundColor ="#6f6c6d"
// <i class="bi bi-x-octagon-fill"></i>
recieverMessage.innerText = " "
const createITag = document.createElement("i")
createITag.style.paddingLeft = '10px'
createITag.className ="bi bi-x-octagon-fill"
const spanTag = document.createElement("span")
spanTag.innerText = "Deleted"
spanTag.style.paddingLeft = "5px"
spanTag.style.color = "#fffff";
createITag.appendChild(spanTag)
recieverMessage.appendChild(createITag)
console.log("inDELETE",data);
console.log("in Delete",recieverMessage);
})

socket.on('online',(data)=>{
    const onlineId = document.getElementById(`${data}online`)
    onlineId.className = "online"
})

socket.on('offline',(data)=>{
    console.log("offline",data);
    const offlineId = document.getElementById(`${data}online`)
    offlineId.className = ""
});
// socket.on('connect', () => {
//   socket.emit('authenticate', { token: cookie }) //send the jwt
// })
socket.on('edit',(data)=>{
    const{messageId,message,status} =data
const recieverMessage = document.getElementById(messageId)
recieverMessage.innerText = message
const newElement  = document.createElement("small")
newElement.style.padding = "11px"
recieverMessage.appendChild(newElement)
console.log(newElement);
})

socket.on('logOut',(data)=>{
socket.emit('logOut',data)
})

socket.on("join-room",(conversationId)=>{

    console.log("client side",conversationId);
})
    mailDiv.addEventListener("keypress",()=>{
        socket.emit('typing','typing...')
    })
    socket.on('typing',function(data){
        const users = document.querySelector(".userId")
        console.log(users);
        const senderId = document.getElementById("senderId").value
        const recieversId = document.getElementById("recieverId").value
        console.log("sender",senderId, "recieverId", recieversId);

        if(senderId&&recieversId){
            document.querySelector('p').innerHTML = data 
        }
    })
    mailDiv.addEventListener("blur",(e)=>{
        socket.emit('stopTyping','typing...')
    })
    socket.on('stopTyping',function(data){
       const active =  document.querySelector('p')
       active.innerHTML = 'Active now' 
    })

     socket.on("sendRequest",(data)=>{
        const{senderId, recieverId} = data

     })
     socket.on('seen-messages',(data)=>{
         const userSenderId = document.getElementById('senderId').value
         const userRecieverId = document.getElementById('recieverId').value
         const{recieverId, senderId} = data
         if(senderId===userRecieverId && userSenderId===recieverId){
             const readTick = document.getElementsByClassName("unRead")
             for(let i=0; i<readTick.length ; i++){
                 console.log(readTick[i]); 
                 readTick[i].style.fill = "#4fc3f7"
                }
            }
        })
        
        let countData = []
     socket.on('chat-message',(data)=>{  
         const{ msg, conversationId,userId, recieverId }  = data;
         const real =  countData.push(msg)
        const textUnderName = document.getElementById(userId);
        textUnderName.innerText = msg
        const countID = document.getElementById(`${userId}count`)
         countID.innerText = real
        const senderId = document.getElementById("senderId").value
        const recieversId = document.getElementById("recieverId").value 
        if(senderId===recieverId && recieversId ===userId){
        const mailDiv = document.getElementById('two')
        const para = document.createElement("div");
        para.className = "clip received"
        const paraTwo = document.createElement("div");
        paraTwo.className = "text"
        const h1 = document.createElement("p");
        h1.className = "text"
        h1.innerText = msg
        paraTwo.appendChild(h1)
        para.appendChild(paraTwo)
        mailDiv.appendChild(para)
        }

    })

const search = document.querySelector(".search")
search.addEventListener("click", async (e)=>{
 const inputSearch = document.querySelector("#search")   
await fetch(`/api/auth/user/searchFriendForSpecificUser?search=${inputSearch.value}`).then((result)=>{
  return result.json()

}).then((result1)=>{
    const body2 =  document.getElementById("body2")
    let html;
    console.log("5555",result1);
      if(result1.data.length==0){
        const html2 = `<h1 style="color: black;"> No user found </h1>`
        body2.innerHTML = html2
      }
else{
     result1.data.forEach((element)=>{
 html +=  ` <div class="row mt-2">
      <div class="col-lg-6">
        <i class="fa fa-user-plus" style="font-size:36px;"></i>
          <a class="text-secondary" href="#">${element.fullName}</a>
        </div>
        <div class="col-lg-6">
          <a class=" btn btn-primary add" href="/api/sendRequest/${element.id}">add Friend </a>
      </div>
    </div>`
        })
        body2.innerHTML = html
    }
})
})

function generateAvatar(text, foregroundColor, backgroundColor) {
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");
    canvas.width = 200;
    canvas.height = 200;
    context.fillStyle = backgroundColor;
    context.fillRect(0, 0, canvas.width, canvas.height);
    context.font = "bold 100px Assistant";
    context.fillStyle = foregroundColor;
    context.textAlign = "center";
    context.textBaseline = "middle";
    context.fillText(text, canvas.width / 2, canvas.height / 2);
    return canvas.toDataURL("image/png");
}
const userName = document.querySelectorAll(".userName")
const image = document.querySelectorAll(".avatar")

for (i = 0; i < image.length; ++i) {
 
    image[i].src = generateAvatar( image[i].name[0], "white", "#009578");
}

// $(document).ready(function() {
// 	$("#message").emojioneArea({
  	
// 		pickerPosition: "right",
//     tonesStyle: "bullet",
// 		events: {
//          	keyup: function (editor, event) {d
//         	}
//     	}
// 	});        
            
// });


</script>
</body>
</html>